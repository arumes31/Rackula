# Shared security headers — included by nginx.conf.template in both
# the server block and any location block that defines its own add_header
# (nginx drops server-level add_header when a location has its own).
#
# SINGLE SOURCE OF TRUTH: Edit headers here, not in nginx.conf.template.
# See: https://nginx.org/en/docs/http/ngx_http_headers_module.html

add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;

# HTTPS hardening — force secure connections for 1 year
# REQUIRES TLS: This header is only meaningful when served over HTTPS.
# Browsers ignore HSTS over plain HTTP (RFC 6797 §7.2). This nginx instance
# must run behind TLS termination (e.g., Caddy, Traefik, or a cloud LB).
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# Privacy controls — limit information leakage and browser feature access
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Content Security Policy - defense-in-depth against XSS
# See: https://github.com/RackulaLives/Rackula/issues/102
# - script-src: Allow scripts from self, Umami analytics, and specific inline scripts (via hash)
#   Script hashes (whitespace-sensitive, recompute if scripts change):
#   - sha256-4afnYZWgiqXvmE6yKMLV6jCv+mJKGuq8qikAiTfRgMc=
#     Source: index.html <script> tag (SPA redirect for GitHub Pages deep links)
#   - sha256-yei5Fza+Eyx4G0smvN0xBqEesIKumz6RSyGsU3FJowI=
#     Source: Dynamic inline script in bundled JS (exact origin unknown)
# - style-src 'self' 'unsafe-inline': Allow inline styles (required for Svelte component scoped styles)
# - img-src 'self' data: blob:: Allow images from same origin, data URLs, and blob URLs (for exports/previews)
# - font-src 'self' fonts.gstatic.com: Allow fonts from same origin and Google Fonts
# - connect-src 'self' t.racku.la: Allow XHR/fetch to same origin and Umami analytics
# - frame-ancestors 'self': Prevent framing by other sites (reinforces X-Frame-Options)
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'sha256-4afnYZWgiqXvmE6yKMLV6jCv+mJKGuq8qikAiTfRgMc=' 'sha256-yei5Fza+Eyx4G0smvN0xBqEesIKumz6RSyGsU3FJowI=' https://t.racku.la; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://t.racku.la; frame-ancestors 'self';" always;
